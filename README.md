# digivisio




## Environments

| Environment | compose |  description  |
|-------------|---------|---------------|
| local devtest   | -f ./docker-compose.yml -f ./docker-compose-local.yml  | Starts up containers including a pgadmin container for managing the database. Builds local images   |
| "production"   | -f ./docker-compose.yml  | Starts up containers for "production" use by pulling images from registry  |


## Local development

### Backend (without container)
Starting the local development backend outside container:   

- Copy backend/.env.sample to backend/.env and make required adjustments if needed
- When running backend and frontend locally, ensure CORS_ORIGIN=http://localhost:3000 points to the exact host and port where the local frontend is run

In backend directory:
```
npm ci
npm start
```


### Frontend (without container)

In frontend directory:
```
yarn install --frozen-lockfile
yarn start
```


### Regenerating the openapi specification and creating typed API client

In backend run: `npm run generate-tsoa`   
This will generate the openapi swagger.json and routes from controllers.

In frontend run: `npm run generate-apiclient`
This will generate the typed API client based on the previously generated swagger.json   
   
Note that files generated by these scripts located in frontend/src/utils/ and backend/src/openapi/ must never be modified manually.

### Local container
The application can be started with docker compose.   

```
# if first run, copy .env.sample to .env
docker-compose -f ./docker-compose.yml -f ./docker-compose-local.yml build
docker-compose -f ./docker-compose.yml -f ./docker-compose-local.yml up
```

After this the following endpoints will be available (default):
| description |  url |   
|-------------|-------|
| Frontend   | https://localhost  |
| Backend    | https://localhost/api/swagger  |
| pgadmin    | http://localhost:5555  |

### Database recreation
Because the database is initialize only once when the postgres container is started for the first time, running the migration file again requires removing the database volume:
```
docker compose -f ./docker-compose.yml -f ./docker-compose-local.yml down
docker compose -f ./docker-compose.yml -f ./docker-compose-local.yml down volumes
docker volume rm digivisio_db-data 
```

When docker compose is brought up the next time the database will be recreated and the init.sql script rerun.
This step can also be done in "production" if needed.

## Authentication
The backend requires "fake" JWT tokens created for this project. Normally this JWT token would be signed by some external provider, or handled with an asymmetric key, but for the purpose of the project a dummy symmetric key and pre-generated JWT tokens are used

The fake JWT tokens contain the following claims:
```
{
  "sub": "<name>",
  "name": "<name>",
  "iat": 1653028308,
  "exp": 1853031908,
  "aud": "digivisio",
  "iss": "digivisioapp"
}
```

The following JWT tokens have been generated and signed:   

| User | sub | JWT |
|------|-----|-----|
| Akseli | akseli  |   eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJha3NlbGkiLCJuYW1lIjoiQWtzZWxpIiwiaWF0IjoxNjUzMDI4MzA4LCJleHAiOjE4NTMwMzE5MDgsImF1ZCI6ImRpZ2l2aXNpbyIsImlzcyI6ImRpZ2l2aXNpb2FwcCJ9.6TKQnmiIs2JdmZcgW-steaTTmIlh2aPycYGTK1z3pNY   |
| Rikhard | rikhard  |  eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJyaWtoYXJkIiwibmFtZSI6IlJpa2hhcmQiLCJpYXQiOjE2NTMwMjgzMDgsImV4cCI6MTg1MzAzMTkwOCwiYXVkIjoiZGlnaXZpc2lvIiwiaXNzIjoiZGlnaXZpc2lvYXBwIn0.V5HL_Ky4OcZHe4F0gYhfhvKuccDKkB2IEWjAZoY3-s0   |
| Mirka | mirka  | eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJtaXJrYSIsIm5hbWUiOiJNaXJrYSIsImlhdCI6MTY1MzAyODMwOCwiZXhwIjoxODUzMDMxOTA4LCJhdWQiOiJkaWdpdmlzaW8iLCJpc3MiOiJkaWdpdmlzaW9hcHAifQ.aF0JhUxok_UQiKDbYoNm0R0y3E_H4AXlyk-RGdzB9XI  |
| Janika | janika  | eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqYW5pa2EiLCJuYW1lIjoiSmFuaWthIiwiaWF0IjoxNjUzMDI4MzA4LCJleHAiOjE4NTMwMzE5MDgsImF1ZCI6ImRpZ2l2aXNpbyIsImlzcyI6ImRpZ2l2aXNpb2FwcCJ9.l2uYr99fOHWKrhAtwNQmEAsdm8LrE9el4rZc20sg-DM     |
| Roosa | roosa  |   eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJyb29zYSIsIm5hbWUiOiJyb29zYSIsImlhdCI6MTY1MzAyODMwOCwiZXhwIjoxODUzMDMxOTA4LCJhdWQiOiJkaWdpdmlzaW8iLCJpc3MiOiJkaWdpdmlzaW9hcHAifQ.d0waCtruX6oWr-4hMQWWlx1gB84vnvBwwJMSOXsv48Y    |

HS256 Signing key: `NTNv7j0TuYARvmNMmWXo6fKvM4o6nv/aUi9ryX38ZH+L1bkrnD1ObOQ8JAUmHCBq7Iy7otZcyAagBLHVKvvYaIpmMuxmARQ97jUVG16Jkpkp1wXOPsrF9zwew6TpczyHkHgX5EuLg2MeBuiT/qJACs1J0apruOOJCg/gOtkjB4c=`  

To access any protected API in the backend an 'Authorization' header with the value `Bearer <jwttoken>` must be included in the request.



# Deployment instructions

The built images are pushed to the private registry `digivisioacr.azurecr.io` on merges to the main branch.

On the target machine run:   

## Install docker (once)
```
sudo yum install yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo systemctl start docker
```

## Login to private docker registry (once)
Before pulling images we need to log in to the private registry. The password can be found in futurice password safe
The credentials will be persisted and usually will not have to be re-entered

```
sudo docker login digivisioacr.azurecr.io -u digivisioacr
```

## Updating the docker-compose file

On developer's laptop:
```
scp docker-compose.yml koe4-dv.csc.fi:~
```

On the server:
```
sudo chown root:root docker-compose.yml
sudo mv docker-compose.yml /home/cloud-user/app/

sudo systemctl restart digivisio.service
```

## Updating the systemd service file

On developer's laptop:
```
scp deployment/digivisio.service koe4-dv.csc.fi:~
```

On the server:
```
sudo chown root:root digivisio.service
sudo mv digivisio.service /etc/systemd/system/

# On the first run only?
# sudo systemctl enable digivisio.service

sudo systemctl restart digivisio.service
```

## Copy required files to the target server
- Copy docker-compose.yml to /home/cloud-user/app/docker-compose.yml
- Copy data/db/init.sql to /home/cloud-user/app/init.db
- Copy .env.sample to /home/cloud-user/app/.env
- Copy the certificates private and public keys to /home/cloud-user/dockercertvolume/ (koe4-dv_csc_fi_cert.cer, koe4-dv.csc.fi.key)


## Deploy a new version of the app
```
sudo docker compose -f /home/cloud-user/app/docker-compose.yml pull
sudo systemctl stop digivisio.service
sudo systemctl start digivisio.service
```

## View logs

```
sudo journalctl -u digivisio.service
```
